<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="./stylesheet.css" />
		<script src="jquery-3.2.1.min.js"></script>
		<style>
			#map {
				border-bottom: 1px solid black;
			}

			table {
				width: 100%;
				border-collapse: collapse;
			}

			td {
				padding: 5px;
			}

			iframe {
				width: 75%;
			}
		</style>
	</head>
	<body>
		<div id="main-content">
			<h1>Loading... Make sure GPS is enabled</h1>
			<br/>
			<img src="./loading_icon.gif" height=100px />
		</div>
		<br/>
		<script>
			function getData(lat, lon) {
				var url = "https://api.yelp.com/v3/businesses/search?sort_by=distance&term=pub&latitude="+lat+"&longitude="+lon;
				//alert(access_token);

				if (access_token === undefined) {
					access_token = "YVeXQlXRroPwUe14e1X_MZE3_AnJUIYJu-4P_eqJxCmQECO70fg-j4lyzw6EM8vbSAQO1QD9YdtlH-dKQWhbMzulCf2lqtiffGMYxA5eOh8IcnNlhZhNLhf6pDdaWXYx";
				}
				var http = new XMLHttpRequest();
				http.open("GET", url, true);
				http.setRequestHeader('Authorization', 'Bearer '+access_token);

				http.onreadystatechange = function() {
				    if(http.readyState == 4 && http.status == 200) {
				        var data = JSON.parse(http.responseText);
				        //alert(JSON.stringify(data));
				        var businesses = data.businesses;
				        var html = "<table>";

				        var nPubs = Math.min(15, businesses.length);

				        for (var i = 0; i < nPubs; i++) {
				        	var pub = businesses[i];
				        	var name = pub.name;
				        	var distance = Math.floor(pub.distance*0.000621371*100)/100 + " mi";
				        	var phone = pub.phone;
				        	var rating = pub.rating;
				        	var price = pub.price;

				        	var img = pub.image_url;

				        	if (price === undefined) {
				        		price = "?";
				        	}

				        	html += "<tr><td id=\"info\"><h3>"+name+"</h3>"+phone+"<br/><br/><strong>User rating:</strong> "+rating+"/5<br/><strong>Price:</strong> "+price+"<br/><strong>Distance:</strong> "+distance+"<br /></td><td id=\"image\"><img src=\""+img+"\" width=50% /><tr><td colspan=\"2\" id=\"map\"><iframe frameborder=\"0\" style=\"border:0\" src=\"https://www.google.com/maps/embed/v1/place?key=AIzaSyD0nveMk1jf-vkKDWJU6yun6-fzGzLG72U &q="+pub.coordinates.latitude+",+"+pub.coordinates.longitude+"\"></iframe><br/><br/></td></tr>"
				        }

				        html += "</table>";
				        //alert(html);
				        document.getElementById("main-content").innerHTML = html;
				    }
				}
				http.send(null);
			}

			function getLoc() {
				navigator.geolocation.getCurrentPosition(function(pos) {
					getData(pos.coords.latitude, pos.coords.longitude);
				}, function(e) {
					alert("Have you turned location on?");
					document.getElementById("main-content").innerHTML = "<h1>Something went wrong</h1><h2>Reload the page from the menu bar</h2>";
				}, {
					timeout: 10000,
					enableHighAccuracy: true
				});
			}

			// Get API Key
			var access_token;
			var req = new XMLHttpRequest();
			var url = "https://api.yelp.com/oauth2/token?client_secret=IEIWyAODCMquJlvl3iDn2KokMN4UjGpi3soDAQyT7pI07UxungFMBpAhgGgPDdS5&client_id=SXV2iuaLjGYb5DX8OgwjtQ&grant_type=client_credentials";
			req.open("POST", url, true);

			req.onreadystatechange = function() {
    			if(req.readyState == 4 && req.status == 200) {
    				var data = JSON.parse(req.responseText);
    				//console.log(data);
			        access_token = data.access_token;
			        // Get location
					getLoc();
			    }
			}
			req.send(null);
		</script>
	</body>
</html>